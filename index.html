<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>极简刷题系统</title>
    <style>
        /* 全局样式：黑白简约+无衬线字体 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        body {
            background: #f8f9fa;
            color: #212529;
            line-height: 1.6;
        }
        button, select, input, textarea {
            font-family: inherit;
            outline: none;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px 12px;
            background: white;
            transition: all 0.2s;
        }
        button:hover {
            background: #e9ecef;
            cursor: pointer;
        }
        button:active {
            background: #dee2e6;
        }

        /* 顶部区域：标题+题库选择+筛选按钮 */
        .header {
            background: white;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #212529;
        }
        .header .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* 中间区域：左导航+右题目（弹性布局） */
        .main {
            display: flex;
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 24px;
            gap: 24px;
        }

        /* 左侧导航栏 */
        .nav-panel {
            width: 280px;
            flex-shrink: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 16px;
            height: fit-content;
            position: sticky;
            top: 80px;
        }
        .nav-header {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f3f5;
        }
        .nav-info {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 16px;
            line-height: 1.8;
        }
        .question-nav {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5列布局，整齐紧凑 */
            gap: 8px;
        }
        .nav-item {
            width: 100%;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .nav-item:hover {
            background: #e9ecef;
        }
        .nav-item.active {
            background: #212529;
            color: white;
        }
        .nav-item.correct {
            background: #34d399;
            color: white;
        }
        .nav-item.wrong {
            background: #f87171;
            color: white;
        }

        /* 右侧题目区域（整页滚动） */
        .question-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .question-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 24px;
            display: block;
        }
        .question-card h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f3f5;
        }
        .option {
            margin: 8px 0;
            padding: 10px 12px;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option:hover {
            background: #e9ecef;
        }
        .option.correct {
            background: #ecfdf5 !important;
            border: 1px solid #34d399;
            color: #065f46;
        }
        .option.wrong {
            background: #fef2f2 !important;
            border: 1px solid #f87171;
            color: #991b1b;
        }
        .fill-input {
            width: 100%;
            max-width: 400px;
            margin: 8px 0;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .fill-input.correct {
            border-color: #34d399;
            background: #ecfdf5;
        }
        .fill-input.wrong {
            border-color: #f87171;
            background: #fef2f2;
        }
        .fill-hint {
            font-size: 14px;
            color: #6c757d;
            margin-top: 4px;
            display: none;
        }
        /* 简答题样式 */
        .sub-question {
            margin: 16px 0;
            padding: 12px;
            border-left: 3px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 0 4px 4px 0;
        }
        .sub-question h4 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .answer-textarea {
            width: 100%;
            min-height: 120px;
            margin: 8px 0;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            resize: vertical;
        }
        .answer-textarea.correct {
            border-color: #34d399;
            background: #ecfdf5;
        }
        .answer-textarea.wrong {
            border-color: #f87171;
            background: #fef2f2;
        }
        .answer-hint {
            font-size: 14px;
            color: #6c757d;
            margin-top: 4px;
            display: none;
        }
        .answer-hint pre {
            background: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin-top: 4px;
            overflow-x: auto;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 13px;
        }
        .show-answer {
            font-size: 14px;
            color: #3b82f6;
            margin-top: 8px;
            cursor: pointer;
            display: inline-block;
        }
        .show-analysis {
            font-size: 14px;
            color: #3b82f6;
            margin-top: 16px;
            cursor: pointer;
            display: inline-block;
        }
        .analysis {
            margin-top: 12px;
            padding: 12px;
            border-radius: 4px;
            background: #f8f9fa;
            font-size: 14px;
            display: none;
        }

        /* 隐藏类 */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 顶部：标题+题库选择+筛选按钮 -->
    <div class="header">
        <h1>极简刷题系统</h1>
        <div class="header-actions">
            <select id="questionBankSelect">
                 <option value="sql_question.json">SQL题库</option>
  <option value="sql.json">sql大题</option>
            </select>
            <button onclick="loadQuestions()">加载题库</button>
            <button onclick="toggleWrongQuestions()" id="filterBtn">只看错题</button>
        </div>
    </div>

    <!-- 中间：左导航+右题目（整页滚动） -->
    <div class="main">
        <!-- 左侧导航栏 -->
        <div class="nav-panel">
            <div class="nav-header">题库导航</div>
            <div class="nav-info" id="examInfo">
                请先加载题库
            </div>
            <div class="question-nav" id="questionNav"></div>
        </div>

        <!-- 右侧题目区域 -->
        <div class="question-panel" id="questionsContainer"></div>
    </div>

    <script>
        let currentExamData = {};
        let questionStatus = []; // 0=未做, 1=做对, 2=做错
        let subQuestionStatus = {}; // 存储简答题子题状态 {qIndex: {subId: 0/1/2}}
        let isShowWrongOnly = false; // 是否只显示错题

       async function loadQuestions() {
    const select = document.getElementById('questionBankSelect');
    const bankUrl = select.value;
    
    try {
        // 加载本地JSON文件
        const response = await fetch(bankUrl);
        if (!response.ok) {
            throw new Error(`无法加载题库文件：${response.status} ${response.statusText}`);
        }
        currentExamData = await response.json();

        if (!Array.isArray(currentExamData.questions)) {
            throw new Error("题库格式错误：缺少questions数组");
        }
        
        // 初始化状态
        questionStatus = new Array(currentExamData.questions.length).fill(0);
        subQuestionStatus = {};
        currentExamData.questions.forEach((q, qIndex) => {
            if (q.type === "简答题" && q.sub_questions) {
                subQuestionStatus[qIndex] = {};
                q.sub_questions.forEach(subQ => {
                    subQuestionStatus[qIndex][subQ.id] = 0;
                });
            }
        });

        isShowWrongOnly = false;
        document.getElementById('filterBtn').textContent = '只看错题';
        
        renderExamInfo();
        renderQuestionNav();
        renderQuestions();
    } catch (e) {
        alert('加载题库失败：' + e.message);
    }
}

        // 渲染题库信息
        function renderExamInfo() {
            const infoDiv = document.getElementById('examInfo');
            infoDiv.innerHTML = `
                <p>标题：${currentExamData.exam_info?.title || '未知题库'}</p>
                <p>总题数：${currentExamData.exam_info?.total_questions || 0}题</p>
                <p>类型：${currentExamData.exam_info?.types?.join('、') || '未知'}</p>
            `;
        }

        // 渲染导航栏
        function renderQuestionNav() {
            const navDiv = document.getElementById('questionNav');
            navDiv.innerHTML = '';
            
            currentExamData.questions.forEach((_, index) => {
                const navItem = document.createElement('div');
                navItem.className = `nav-item`;
                navItem.textContent = index + 1;
                navItem.onclick = () => scrollToQuestion(index);
                navDiv.appendChild(navItem);
            });
        }

        // 渲染所有题目（整页滚动）
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            currentExamData.questions.forEach((q, index) => {
                // 只看错题时过滤
                const shouldShow = !isShowWrongOnly || questionStatus[index] === 2;
                const questionCard = document.createElement('div');
                questionCard.className = `question-card ${shouldShow ? '' : 'hidden'}`;
                questionCard.id = `question_${index}`;

                // 处理单选题（兼容原选择题逻辑）
                if (q.type === "选择题" || q.type === "单选题") {
                    const optionsArr = Object.entries(q.options || {}).map(([key, value]) => ({key, value}));
                    questionCard.innerHTML = `
                        <h3>第${index+1}题（${q.type}）：${q.title}</h3>
                        <div class="options">
                            ${optionsArr.map((opt) => `
                                <div class="option" onclick="checkChoiceAnswer(${index}, '${opt.key}', this)">
                                    ${opt.key}. ${opt.value}
                                </div>
                            `).join('')}
                        </div>
                        <div class="show-analysis" onclick="toggleAnalysis(${index})">查看解析</div>
                        <div class="analysis" id="analysis_${index}">${q.analysis || '暂无解析'}</div>
                    `;
                } 
                // 处理填空题
                else if (q.type === "填空题") {
                    questionCard.innerHTML = `
                        <h3>第${index+1}题（${q.type}）：${q.title}</h3>
                        <input type="text" class="fill-input" placeholder="请输入答案" 
                               onblur="checkFillAnswer(${index}, this)">
                        <div class="fill-hint" id="fill_hint_${index}">
                            正确答案：${q.correct_answer || '暂无答案'}
                        </div>
                        <div class="show-analysis" onclick="toggleAnalysis(${index})">查看解析</div>
                        <div class="analysis" id="analysis_${index}">${q.analysis || '暂无解析'}</div>
                    `;
                }
                // 处理简答题
                else if (q.type === "简答题" && q.sub_questions) {
                    let subQuestionsHtml = '';
                    q.sub_questions.forEach((subQ, subIndex) => {
                        const subId = subQ.id;
                        subQuestionsHtml += `
                            <div class="sub-question">
                                <h4>${subId} ${subQ.title}</h4>
                                <textarea class="answer-textarea" placeholder="请输入答案（SQL语句）"
                                    onblur="checkSubAnswer(${index}, '${subId}', this)">
                                </textarea>
                                <div class="answer-hint" id="answer_hint_${index}_${subId}">
                                    正确答案：
                                    <pre>${subQ.answer || '暂无答案'}</pre>
                                </div>
                                <div class="show-answer" onclick="toggleSubAnswer(${index}, '${subId}')">查看正确答案</div>
                                <div class="analysis" id="sub_analysis_${index}_${subId}" style="margin-top:8px;display:none;">
                                    ${subQ.analysis || '暂无解析'}
                                </div>
                                <div class="show-analysis" onclick="toggleSubAnalysis(${index}, '${subId}')">查看解析</div>
                            </div>
                        `;
                    });

                    questionCard.innerHTML = `
                        <h3>第${index+1}题（${q.type}）：${q.title}</h3>
                        ${subQuestionsHtml}
                    `;
                }
                // 其他题型默认展示
                else {
                    questionCard.innerHTML = `
                        <h3>第${index+1}题（${q.type}）：${q.title}</h3>
                        <p>暂不支持该题型的答题功能</p>
                        <div class="show-analysis" onclick="toggleAnalysis(${index})">查看解析</div>
                        <div class="analysis" id="analysis_${index}">${q.analysis || '暂无解析'}</div>
                    `;
                }
                container.appendChild(questionCard);
            });
        }

        // 滚动到指定题目
        function scrollToQuestion(index) {
            const targetQuestion = document.getElementById(`question_${index}`);
            if (targetQuestion) {
                targetQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // 高亮当前题号（1秒后取消）
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                navItems[index].classList.add('active');
                setTimeout(() => {
                    if (navItems[index]) navItems[index].classList.remove('active');
                }, 1000);
            }
        }

        // 切换只看错题/显示全部
        function toggleWrongQuestions() {
            isShowWrongOnly = !isShowWrongOnly;
            const filterBtn = document.getElementById('filterBtn');
            filterBtn.textContent = isShowWrongOnly ? '显示全部' : '只看错题';
            renderQuestions();
        }

        // 选择题校验
        function checkChoiceAnswer(qIndex, optKey, optionDiv) {
            const q = currentExamData.questions[qIndex];
            const allOptions = optionDiv.parentElement.querySelectorAll('.option');
            
            allOptions.forEach(opt => opt.classList.remove('correct', 'wrong'));

            let isCorrect = optKey === q.correct_answer;
            optionDiv.classList.add(isCorrect ? 'correct' : 'wrong');
            
            // 标记正确选项
            if (!isCorrect) {
                allOptions.forEach(opt => {
                    if (opt.textContent.slice(0, 1) === q.correct_answer) {
                        opt.classList.add('correct');
                    }
                });
            }

            // 更新状态和导航栏
            questionStatus[qIndex] = isCorrect ? 1 : 2;
            updateNavItemStatus(qIndex);
        }

        // 填空题校验
        function checkFillAnswer(qIndex, inputEl) {
            const q = currentExamData.questions[qIndex];
            const hintDiv = document.getElementById(`fill_hint_${qIndex}`);
            hintDiv.style.display = 'block';

            const userAnswer = inputEl.value.toLowerCase().trim();
            const correctAnswer = (q.correct_answer || '').toLowerCase().trim();
            let isCorrect = userAnswer === correctAnswer;

            inputEl.classList.toggle('correct', isCorrect);
            inputEl.classList.toggle('wrong', !isCorrect);

            questionStatus[qIndex] = isCorrect ? 1 : 2;
            updateNavItemStatus(qIndex);
        }

        // 简答题子题校验
        function checkSubAnswer(qIndex, subId, textareaEl) {
            const q = currentExamData.questions[qIndex];
            const subQ = q.sub_questions.find(item => item.id === subId);
            const hintDiv = document.getElementById(`answer_hint_${qIndex}_${subId}`);
            
            if (!subQ) return;

            // 简单校验（忽略空格、换行、大小写）
            const userAnswer = textareaEl.value.trim().replace(/\s+/g, '').toLowerCase();
            const correctAnswer = (subQ.answer || '').trim().replace(/\s+/g, '').toLowerCase();
            const isCorrect = userAnswer === correctAnswer;

            textareaEl.classList.toggle('correct', isCorrect);
            textareaEl.classList.toggle('wrong', !isCorrect);
            
            // 更新子题状态
            subQuestionStatus[qIndex][subId] = isCorrect ? 1 : 2;
            
            // 检查该简答题所有子题是否都正确
            const allSubCorrect = Object.values(subQuestionStatus[qIndex]).every(status => status === 1);
            const anySubWrong = Object.values(subQuestionStatus[qIndex]).some(status => status === 2);
            
            // 更新主题目状态
            if (allSubCorrect) {
                questionStatus[qIndex] = 1;
            } else if (anySubWrong) {
                questionStatus[qIndex] = 2;
            }
            
            updateNavItemStatus(qIndex);
        }

        // 显示/隐藏简答题子题答案
        function toggleSubAnswer(qIndex, subId) {
            const hintDiv = document.getElementById(`answer_hint_${qIndex}_${subId}`);
            hintDiv.style.display = hintDiv.style.display === 'block' ? 'none' : 'block';
        }

        // 显示/隐藏简答题子题解析
        function toggleSubAnalysis(qIndex, subId) {
            const analysisDiv = document.getElementById(`sub_analysis_${qIndex}_${subId}`);
            analysisDiv.style.display = analysisDiv.style.display === 'block' ? 'none' : 'block';
        }

        // 更新导航栏题号状态
        function updateNavItemStatus(qIndex) {
            const navItem = document.querySelectorAll('.nav-item')[qIndex];
            if (navItem) {
                navItem.classList.remove('correct', 'wrong');
                if (questionStatus[qIndex] === 1) {
                    navItem.classList.add('correct');
                } else if (questionStatus[qIndex] === 2) {
                    navItem.classList.add('wrong');
                }
            }
        }

        // 显示/隐藏解析
        function toggleAnalysis(index) {
            const analysisDiv = document.getElementById(`analysis_${index}`);
            if (analysisDiv) {
                analysisDiv.style.display = analysisDiv.style.display === 'block' ? 'none' : 'block';
            }
        }

        // 页面加载完成后默认加载第一个题库
        window.onload = function() {
            loadQuestions();
        };
    </script>
</body>

</html>

